<div class="title">
  <h2><%= term_filter %></h2>
  <h1>Test Scores</h1>
  <%= link_for :fullscreen, controller_model %>
  <%= link_for :import, controller_model %>
  <%= link_for :search, controller_model %>
</div>
  
<div class="scroller">
  <div class="table" data-limit="<%= offset_amount %>" data-offset="<%= params[:offset].to_i + offset_amount %>">
    <div>
      <span class="spacer"></span>
      <span class="image"></span>
      <span data-order-by="students.identifier" class="sortable">Identifier</span>
      <span data-order-by="students.last_name" class="sortable">Name</span>
      <span data-order-by="students.grade" class="sortable replace_target">Grade</span>
      <% score_columns.each do |test_name, terms_and_keys| %>
        <% terms_and_keys.each do |term, keys| %>
          <% keys.each do |key| %>
            <span <%= data_column_attributes(test_name, term, key) %>>
              <%= test_name.upcase %> <%= term %><br />
              <%= key.titleize %>
            </span>
          <% end %>
        <% end %>
      <% end %>
      <span class="spacer"></span>
    </div>
    <% group_levels(collection).each do |level, students| %>
      <% if level %>
        <a class="<%= level.downcase %> level_breaker">
          <span class="spacer"></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <% score_columns.each do |test_name, terms_and_keys| %>
            <% terms_and_keys.each do |term, keys| %>
              <% keys.each do |key| %>
                <% if key == @ordered[:key] && term == @ordered[:term] && test_name == @ordered[:test_name] %>
                  <span><%= level %></span>
                <% else %>
                  <span></span>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
          <span class="spacer"></span>
        </a>
      <% end %>
      <% students.each do |student| %>
        <a href="<%= "#{request.path}/#{student.id}" %>" data-id="<%= student.id %>">
          <span class="spacer"></span>
          <span class="image">
            <%= image_tag(student.image(:index)) if student.image? %>
          </span>
          <span><%= student.identifier %></span>
          <span><%= student.name %></span>
          <span><%= student.grade %></span>
          <% associated_test_scores(student.test_scores) do |association| %>
            <% score_columns.each do |test_name, terms_and_keys| %>
              <% terms_and_keys.each do |term, keys| %>
                <% if score = association[[test_name, term]] %>
                  <% keys.each do |key| %>
                    <% if level = score.data["#{key}_lv"] %>
                      <span class="<%= level.downcase %>">
                        <%= score.data[key] || none %>
                        <i><%= level %></i>
                      </span>
                    <% else %>
                      <span><%= score.data[key] || none %></span>
                    <% end %>
                  <% end %>
                <% else %>
                  <% keys.each do |key| %>
                    <span><%= none %></span>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
          <span class="spacer"></span>
        </a>
      <% end %>
    <% end %>
  </div>
</div>